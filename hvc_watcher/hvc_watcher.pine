// Copyright 2025 Major Hayden
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
//
//@version=6
indicator('HVC Watcher', shorttitle = 'HVC Watch', overlay = true, max_lines_count = 200, max_labels_count = 500)

// Volume settings
sma_length = input.int(20, title = 'Volume SMA Length', minval = 1, group = 'Volume Settings', tooltip = 'Number of bars used to calculate the volume simple moving average (SMA)')
volume_multiplier = input.float(3.0, title = 'HVC Multiplier Threshold', minval = 1.0, step = 0.1, group = 'Volume Settings', tooltip = 'Volume must be at least this many times the SMA to trigger a High Volume Close (HVC)')

// Marker settings
color_hve = input.color(color.green, title = 'HVE Color', group = 'Markers', tooltip = 'Color for Highest Volume Ever (HVE) markers - bars with the highest volume seen on the chart')
color_hvc = input.color(color.orange, title = 'HVC Color', group = 'Markers', tooltip = 'Color for High Volume Close (HVC) markers - bars where volume exceeds the SMA threshold')
shape_style = input.string('circles', title = 'Shape Style', options = ['circles', 'triangleup', 'diamond', 'cross', 'xcross'], group = 'Markers')
priority_mode = input.bool(true, title = 'Priority Mode', group = 'Markers', tooltip = 'When enabled, only shows the highest priority marker (HVE > HVC) to avoid overlap')

// Zone settings
show_zones = input.bool(true, title = 'Show HVC Zones', group = 'Zones', tooltip = 'Draw horizontal zones marking the high/low range of HVC bars')
zone_color = input.color(color.blue, title = 'Zone Color', group = 'Zones')
zone_transparency = input.int(95, title = 'Zone Fill Transparency (%)', minval = 0, maxval = 100, group = 'Zones')
zone_edge_transparency = input.int(80, title = 'Zone Edge Transparency (%)', minval = 0, maxval = 100, group = 'Zones')

// Label settings
show_multiplier_labels = input.bool(false, title = 'Show Volume Multiplier Labels', group = 'Labels', tooltip = 'Display the volume multiplier (e.g., 5x) next to HVC bars')
multiplier_label_color = input.color(color.orange, title = 'Multiplier Label Background', group = 'Labels')
multiplier_text_color = input.color(color.black, title = 'Multiplier Label Text', group = 'Labels')
show_current_multiplier = input.bool(false, title = 'Show Current Bar Multiplier', group = 'Labels', tooltip = 'Display real-time volume multiplier for the current (incomplete) bar')
current_label_color = input.color(color.new(color.blue, 50), title = 'Current Bar Label Background', group = 'Labels')
current_text_color = input.color(color.white, title = 'Current Bar Label Text', group = 'Labels')

// Calculate volume SMA
volume_sma = ta.sma(volume, sma_length)

// Check for all-time highest volume
var float hve_threshold = 0
hve_threshold := math.max(hve_threshold, nz(volume[1], 0))
is_hve = volume > hve_threshold and volume > 0

// Check for volume at least X times the SMA
is_hvc = volume >= volume_sma * volume_multiplier

// Cache volume multiplier calculation (used in multiple places)
volume_multiplier_value = volume_sma > 0 ? volume / volume_sma : 0

// Function to get the appropriate shape
getShape(style) =>
    switch style
        'circles' => shape.circle
        'triangleup' => shape.triangleup
        'diamond' => shape.diamond
        'cross' => shape.cross
        'xcross' => shape.xcross
        => shape.circle

selected_shape = getShape(shape_style)

// Determine which markers to show based on priority mode
// Priority: HVE > HVC
show_hve = is_hve
show_hvc = priority_mode ? is_hvc and not is_hve : is_hvc

// Combined HVE or HVC detection
is_hve_or_hvc = is_hve or is_hvc

// Plot volume multiplier labels if enabled
if show_multiplier_labels and is_hvc and volume_sma > 0
    multiplier_rounded = math.round(volume_multiplier_value)
    label_text = str.tostring(multiplier_rounded) + "x"
    label.new(bar_index, close, label_text,
              color = multiplier_label_color,
              textcolor = multiplier_text_color,
              style = label.style_label_right,
              size = size.normal)

plotshape(series = show_hve, location = location.abovebar, style = selected_shape, size = size.tiny, color = color_hve, title = 'HVE (Highest Volume Ever)')
plotshape(series = show_hvc, location = location.abovebar, style = selected_shape, size = size.tiny, color = color_hvc, title = 'HVC (High Volume Close)')

// Add alerts
alertcondition(is_hve, title = 'HVE', message = 'Highest Volume Ever detected on {{ticker}}')
alertcondition(show_hvc, title = 'HVC', message = 'High Volume Close detected on {{ticker}}')
alertcondition(is_hve_or_hvc, title = 'HVE or HVC', message = 'HVE or HVC detected on {{ticker}}')

// Display current values in data window
plot(volume, title = 'Volume', display = display.data_window)
plot(volume_sma, title = 'Volume SMA', display = display.data_window)
plot(hve_threshold, title = 'HVE Threshold', display = display.data_window)

// Draw zones on HVC days using linefill
if show_zones and is_hvc
    fillColor = color.new(zone_color, zone_transparency)
    edgeColor = color.new(zone_color, zone_edge_transparency)
    topLine = line.new(bar_index, high, bar_index + 1, high, extend = extend.right, color = edgeColor)
    bottomLine = line.new(bar_index, low, bar_index + 1, low, extend = extend.right, color = edgeColor)
    linefill.new(topLine, bottomLine, color = fillColor)

// Show real-time multiplier for current bar
if show_current_multiplier and barstate.islast and volume_sma > 0
    current_mult_text = str.tostring(math.round(volume_multiplier_value)) + "x"
    var label current_label = na
    label.delete(current_label)
    current_label := label.new(bar_index, low, current_mult_text,
                              color = current_label_color,
                              textcolor = current_text_color,
                              style = label.style_label_upper_left,
                              size = size.normal)
